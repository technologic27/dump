# MongoDB Setup Guide
----

## REQUIREMENTS

> This guide assumes that you already have Percona MongoDB up and running on your system.


----------------------------------------
## Configuration

### Config File Location

Great, so you have MongoDB up and running on your system. The default mongodb configuration file (if you set it up as per the above guide) will be located at `/etc/mongod.conf`.
Take a quick peek at it and note the following details which we will be changing:

> Note: Do NOT edit this file (unless you're the owner)

```bash
less /etc/mongod.config
```

```python
# Where and how to store data.
storage:
  dbPath: /var/lib/mongodb
  journal:
    enabled: true

#....
#Tons of Parameters in between that are commented out.
#...

# Finally...

# where to write logging data.
systemLog:
  destination: file
  logAppend: true
  path: /var/log/mongodb/mongod.log

processManagement:
  fork: true
  pidFilePath: /var/run/mongod.pid

# network interfaces
net:
  port: 27001
  bindIp: 127.0.0.1

security:
  authorization: enabled
```

## Create your Config file

So the next step is to **copy** this config file and edit it according to our needs. Let's say we want to call the new mongodb instance - mongodb2:

`sudo cp /etc/mongod.conf /home/yourusername/mongod2.conf`

Then change the following parameters using your favourite editor (`sudo vim ~/mongod2.conf`), leaving the rest for now:
1. Storage: This parameter controls where the mongodb data will be stored. Change the following line only
  ```python
 storage:
    dbPath: /ebs/mount/path #E.g. /data/var/lib
  ```

2. systemLog: This parameter controls the mongodb logfile destination.
```python
systemLog:
  destination: file #No change
  logAppend: true # No change
  path: /ebs/path/to/logfile.log #E.g. /data/var/log/mongodb-2.log
```
3. processManagement: This controls the forking and multithreading of mongo. It uses a '.pid' file to manage forks. Ideally this should be located on the root filesystem. Ensure that you do not overwrite the original mongod.pid file!
```python
processManagement:
  fork: true #No change
  pidFilePath: /path/to/mongodb-2.pid #/var/run/mongodb-2.pid
  ```
4. net: This is the accesspoint of the new mongodb instance. Ensure that it does not conflict with any existing mongodb instances or any other services that may be using the port. A good rule of thumb is to increment any existing MongoDB port number and use that. Also do not forget to update the sharepoint file at the [Ports Sharepoint File](https://globalappsportal-my.sharepoint.com/personal/deb_goswami_dentsuaegis_com/_layouts/15/guestaccess.aspx?guestaccesstoken=tfOFvFQfev5T7PrDcs7BEmhWH7bdkZ7uHVcICl8uiE0%3d&docid=17fb130020f8a44a49909d109c773b7bb&rev=1)
```python
net:
  port: 27002 #27001 existing port
  bindIp: 127.0.0.1
```

5. security: Leave it as is (enabled)
```python
security:
  authorization: enabled
  ```


### Guidelines
1. Guidelines for production systems recommend that snapshots, journals and logfiles not be kept on the same EBS volume in order to avoid excessive IO on a single disk. We can avoid this for now - but bear in mind if you start facing performance issues as the data gets larger.
2. For the same reason, try to avoid keeping multiple mongodb db resources on the same EBS. For now, use the simple guideline of 1 MongoDB : 1 EBS volume.
3. If you're unsure, ask **BEFORE** setting up. It is not easier to ask for forgiveness than permission on the cloud. Especially when Terrabytes of data are involved :)

## Config File
After you have finished making the changes to your config file (you did rename it something other than monod.conf right?), copy it back to the /etc/ folder. You will need `sudo` permissions for this:

`sudo cp ~/mongod2.conf /etc/mongod2.conf`

## Launching MongoDB

Now it is time to launch the new mongodb instance. We do this using the `systemd` utility in ubuntu and by pointing to the new .conf file that was created. We also need to  ensure  that our `mongod` binary does not conflict.:

```bash
#Copy the mongod bin
sudo cp /usr/bin/mongod /usr/bin/mongod2

#Start the service using the new bin and conf file
sudo systemctl start mongod2 -f /etc/mongod2.conf
```

## Test
Is it working?

`% sudo systemctl status mongod2`

-------------------

If everything was configured correctly, you should be able to connect to your mongo instance using:

`mongo --port 27002 -u username -p`

## Useful Links
* [Percona MongoDB Parameter FAQ](https://www.percona.com/doc/percona-server-for-mongodb/3.2/index.html)
* [General MongoDB Tutorial](https://docs.mongodb.com/v3.2/tutorial/)
* [AWS MongoDB Guide](https://docs.mongodb.com/ecosystem/platforms/amazon-ec2/)
* [Online MongoD Parallel Config](http://www.alphadevx.com/a/491-Running-two-MongoDB-instances-on-one-server)

--------------------------
